version: "2.4"

services:
  agentdev:
    build: .
    command: ["bash", "-lc", "pytest -q --maxfail=1 -m 'not seal and not slow'"]
    environment:
      - ENV=TEST
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - REDIS_URL=redis://redis:6379
      - PROMETHEUS_URL=http://prometheus:9090
    depends_on: 
      - redis
      - otel-collector
    networks: 
      - test_net
    volumes:
      - ./tests:/app/tests:ro
      - ./agentdev:/app/agentdev:ro
      - test_sqlite:/app/.agentdev
      - test_logs:/app/logs
    cpus: "2"
    mem_limit: "2g"
    pids_limit: 512
    ulimits:
      nofile: 4096
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    command: [
      "redis-server",
      "--save", "",
      "--appendonly", "no", 
      "--maxmemory", "512mb",
      "--maxmemory-policy", "allkeys-lru",
      "--port", "6379"
    ]
    networks: 
      - test_net
    volumes:
      - test_redis:/data
    cpus: "1"
    mem_limit: "512m"
    pids_limit: 256
    ulimits:
      nofile: 2048
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  otel-collector:
    image: otel/opentelemetry-collector:0.104.0
    command: ["--config=/etc/otel-config.yml"]
    volumes:
      - ./ops/otel/otel-config.yml:/etc/otel-config.yml:ro
      - test_otel:/tmp
    networks: 
      - test_net
    ports:
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
      - "8888:8888"   # Prometheus metrics
    cpus: "0.5"
    mem_limit: "256m"
    pids_limit: 128
    ulimits:
      nofile: 1024
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3

  prometheus:
    image: prom/prometheus:v2.54.1
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=7d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    volumes:
      - ./ops/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./ops/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - test_prometheus:/prometheus
    networks: 
      - test_net
    ports:
      - "9090:9090"
    cpus: "0.5"
    mem_limit: "512m"
    pids_limit: 128
    ulimits:
      nofile: 1024
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  test_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  test_sqlite:
    driver: local
  test_redis:
    driver: local
  test_otel:
    driver: local
  test_prometheus:
    driver: local
  test_logs:
    driver: local
