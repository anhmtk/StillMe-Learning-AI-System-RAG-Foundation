# StillMe Interaction Policy - Single Source of Truth
# Policy trung t√¢m cho h√†nh vi Skip/Cancel/Abort/Stop
# Version: 1.0
# Created: 2025-09-22
# Purpose: Chu·∫©n ho√° "Skip = Diagnose" thay v√¨ "Skip = Cancel"

version: 1
metadata:
  name: "StillMe Interaction Policy"
  description: "Policy trung t√¢m cho h√†nh vi t∆∞∆°ng t√°c Skip/Cancel/Abort/Stop"
  author: "StillMe Platform Team"
  last_updated: "2025-09-22T00:21:00Z"

skip:
  # Semantics: Skip c√≥ nghƒ©a l√† "ch·∫©n ƒëo√°n tr·∫°ng th√°i", KH√îNG ph·∫£i "h·ªßy b·ªè"
  semantics: "diagnose"   # not cancel
  
  # Actions th·ª±c hi·ªán khi b·∫•m Skip
  actions: 
    - "tail_logs"        # ƒê·ªçc N d√≤ng cu·ªëi c·ªßa log
    - "check_heartbeat"  # Ki·ªÉm tra heartbeat file
    - "check_pid"        # Ki·ªÉm tra process ID
  
  # Timeouts cho ch·∫©n ƒëo√°n
  timeouts: 
    diagnose_ms: 3000    # 3 gi√¢y ƒë·ªÉ ch·∫©n ƒëo√°n
    heartbeat_timeout_ms: 5000  # 5 gi√¢y timeout cho heartbeat
  
  # Output states c√≥ th·ªÉ c√≥
  outputs: 
    - "COMPLETED"        # Task ƒë√£ ho√†n th√†nh
    - "RUNNING"          # Task ƒëang ch·∫°y
    - "STALLED"          # Task b·ªã treo
    - "UNKNOWN"          # Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c tr·∫°ng th√°i
  
  # Prompts hi·ªÉn th·ªã cho user
  prompts:
    completed_vi: "‚úÖ T√°c v·ª• ƒë√£ ho√†n th√†nh th√†nh c√¥ng."
    running_vi: "üîÑ T√°c v·ª• v·∫´n ƒëang ch·∫°y. Ch·ªù th√™m hay chuy·ªÉn 'Background'?"
    stalled_vi: "‚ö†Ô∏è T√°c v·ª• c√≥ d·∫•u hi·ªáu treo. Mu·ªën 'Resume', 'Retry' hay 'Kill'?"
    unknown_vi: "‚ùì Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c tr·∫°ng th√°i. Ki·ªÉm tra log th·ªß c√¥ng?"
    
    completed_en: "‚úÖ Task completed successfully."
    running_en: "üîÑ Task is still running. Wait more or move to 'Background'?"
    stalled_en: "‚ö†Ô∏è Task appears stalled. Want to 'Resume', 'Retry' or 'Kill'?"
    unknown_en: "‚ùì Unable to determine status. Check logs manually?"
  
  # C·∫•m g·ªçi cancel() khi b·∫•m Skip
  cancel_on_skip: false
  
  # Log tailing configuration
  log_tailing:
    default_lines: 200    # S·ªë d√≤ng m·∫∑c ƒë·ªãnh ƒë·ªÉ ƒë·ªçc
    max_lines: 1000      # S·ªë d√≤ng t·ªëi ƒëa
    patterns:
      completed: ["DONE", "Success", "‚úÖ", "completed", "finished"]
      error: ["ERROR", "FAILED", "‚ùå", "error", "failed", "exception"]
      running: ["RUNNING", "Processing", "üîÑ", "running", "processing"]

cancel:
  # Cancel c√≥ nghƒ©a l√† "h·ªßy b·ªè th·ª±c s·ª±"
  semantics: "abort"
  
  # Actions th·ª±c hi·ªán khi b·∫•m Cancel
  actions:
    - "terminate_process"  # K·∫øt th√∫c process
    - "cleanup_resources"  # D·ªçn d·∫πp resources
    - "notify_user"        # Th√¥ng b√°o cho user
  
  # Confirmation required
  require_confirmation: true
  confirmation_message_vi: "‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy t√°c v·ª• n√†y?"
  confirmation_message_en: "‚ö†Ô∏è Are you sure you want to cancel this task?"

abort:
  # Abort c√≥ nghƒ©a l√† "d·ª´ng kh·∫©n c·∫•p"
  semantics: "emergency_stop"
  
  # Actions th·ª±c hi·ªán khi b·∫•m Abort
  actions:
    - "force_terminate"    # Bu·ªôc k·∫øt th√∫c
    - "emergency_cleanup"  # D·ªçn d·∫πp kh·∫©n c·∫•p
    - "alert_admin"        # C·∫£nh b√°o admin
  
  # No confirmation for emergency
  require_confirmation: false

stop:
  # Stop c√≥ nghƒ©a l√† "d·ª´ng graceful"
  semantics: "graceful_shutdown"
  
  # Actions th·ª±c hi·ªán khi b·∫•m Stop
  actions:
    - "graceful_shutdown"  # D·ª´ng graceful
    - "save_state"         # L∆∞u tr·∫°ng th√°i
    - "cleanup_resources"  # D·ªçn d·∫πp resources
  
  # Timeout cho graceful shutdown
  shutdown_timeout_ms: 10000  # 10 gi√¢y

# Heartbeat configuration
heartbeat:
  # Heartbeat file locations
  files:
    - ".heartbeat"
    - "logs/heartbeat.log"
    - "runtime/heartbeat.json"
  
  # Heartbeat check interval
  check_interval_ms: 1000  # 1 gi√¢y
  
  # Heartbeat timeout
  timeout_ms: 5000  # 5 gi√¢y

# Log configuration
logs:
  # Log file locations
  files:
    - "logs/app.log"
    - "logs/error.log"
    - "logs/debug.log"
    - "runtime/current.log"
  
  # Log tailing configuration
  tailing:
    buffer_size: 8192
    encoding: "utf-8"
    follow: true

# PID monitoring
pid:
  # PID file locations
  files:
    - ".pid"
    - "runtime/process.pid"
    - "logs/process.pid"
  
  # PID check interval
  check_interval_ms: 2000  # 2 gi√¢y

# UI Integration
ui:
  # Skip button behavior
  skip_button:
    text_vi: "Skip"
    text_en: "Skip"
    tooltip_vi: "Ch·∫©n ƒëo√°n tr·∫°ng th√°i t√°c v·ª•"
    tooltip_en: "Diagnose task status"
    icon: "üîç"
  
  # Cancel button behavior
  cancel_button:
    text_vi: "H·ªßy"
    text_en: "Cancel"
    tooltip_vi: "H·ªßy b·ªè t√°c v·ª•"
    tooltip_en: "Cancel task"
    icon: "‚ùå"
  
  # Status display
  status_display:
    show_diagnosis: true
    show_actions: true
    auto_refresh_ms: 2000

# Compliance
compliance:
  # Required for all entrypoints
  required_entrypoints:
    - "UI components"
    - "CLI tools"
    - "Backend services"
    - "Mobile apps"
  
  # Policy loading requirement
  must_load_policy: true
  
  # CI/CD integration
  ci_checks:
    - "check_policy_loaded"
    - "check_skip_not_cancel"
    - "check_file_protection"
