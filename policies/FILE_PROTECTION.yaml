# StillMe File Protection Policy - Single Source of Truth
# Policy trung t√¢m cho b·∫£o v·ªá files quan tr·ªçng
# Version: 1.0
# Created: 2025-09-22
# Purpose: B·∫£o v·ªá .env v√† c√°c files quan tr·ªçng kh·ªèi b·ªã xo√°/ƒë·ªïi t√™n/commit nh·∫ßm

version: 1
metadata:
  name: "StillMe File Protection Policy"
  description: "Policy trung t√¢m cho b·∫£o v·ªá files quan tr·ªçng (.env, config, secrets)"
  author: "StillMe Platform Team"
  last_updated: "2025-09-22T00:30:00Z"
  critical: true  # This policy is critical for security

# Protected files - tuy·ªát ƒë·ªëi kh√¥ng ƒë∆∞·ª£c xo√°/ƒë·ªïi t√™n
protected_files:
  - ".env"                    # Main environment file
  - ".env.local"             # Local environment

# Rules cho t·ª´ng lo·∫°i operation
rules:
  delete:
    action: "deny"           # Tuy·ªát ƒë·ªëi c·∫•m xo√°
    severity: "critical"     # M·ª©c ƒë·ªô nghi√™m tr·ªçng
    auto_backup: true        # T·ª± ƒë·ªông backup tr∆∞·ªõc khi xo√°
    require_approval: true   # C·∫ßn approval t·ª´ admin
    
  rename:
    action: "deny"           # Tuy·ªát ƒë·ªëi c·∫•m ƒë·ªïi t√™n
    severity: "critical"
    auto_backup: true
    require_approval: true
    
  move:
    action: "deny"           # Tuy·ªát ƒë·ªëi c·∫•m di chuy·ªÉn
    severity: "critical"
    auto_backup: true
    require_approval: true
    
  modify:
    action: "require_approval"  # C·∫ßn approval ƒë·ªÉ s·ª≠a
    severity: "high"
    auto_backup: true
    require_approval: true
    validation_required: true  # C·∫ßn validate content
    
  copy:
    action: "allow"          # Cho ph√©p copy
    severity: "low"
    auto_backup: false
    require_approval: false
    
  read:
    action: "allow"          # Cho ph√©p ƒë·ªçc
    severity: "low"
    auto_backup: false
    require_approval: false

# Commit rules
commit:
  .env: "ignore"             # Kh√¥ng commit .env
  .env.local: "ignore"       # Kh√¥ng commit .env.local
  .env.prod: "ignore"        # Kh√¥ng commit .env.prod
  .env.dev: "ignore"         # Kh√¥ng commit .env.dev
  .env.staging: "ignore"     # Kh√¥ng commit .env.staging
  .env.test: "ignore"        # Kh√¥ng commit .env.test
  .env.backup: "ignore"      # Kh√¥ng commit .env.backup
  .env.old: "ignore"         # Kh√¥ng commit .env.old
  .env.orig: "ignore"        # Kh√¥ng commit .env.orig
  .env.template: "ignore"    # Kh√¥ng commit .env.template
  .env.notifications: "ignore"  # Kh√¥ng commit .env.notifications
  .env.secrets: "ignore"     # Kh√¥ng commit .env.secrets
  .env.keys: "ignore"        # Kh√¥ng commit .env.keys
  .env.credentials: "ignore" # Kh√¥ng commit .env.credentials
  .env.example: "allow"      # Cho ph√©p commit .env.example

# Messages cho user
messages:
  delete_violation_vi: "‚ùå Kh√¥ng ƒë∆∞·ª£c xo√° file .env. File n√†y ch·ª©a th√¥ng tin nh·∫°y c·∫£m."
  delete_violation_en: "‚ùå Cannot delete .env file. This file contains sensitive information."
  
  rename_violation_vi: "‚ùå Kh√¥ng ƒë∆∞·ª£c ƒë·ªïi t√™n file .env. File n√†y ch·ª©a th√¥ng tin nh·∫°y c·∫£m."
  rename_violation_en: "‚ùå Cannot rename .env file. This file contains sensitive information."
  
  move_violation_vi: "‚ùå Kh√¥ng ƒë∆∞·ª£c di chuy·ªÉn file .env. File n√†y ch·ª©a th√¥ng tin nh·∫°y c·∫£m."
  move_violation_en: "‚ùå Cannot move .env file. This file contains sensitive information."
  
  modify_violation_vi: "‚ö†Ô∏è S·ª≠a file .env c·∫ßn x√°c nh·∫≠n r√µ r√†ng v√† approval t·ª´ admin."
  modify_violation_en: "‚ö†Ô∏è Modifying .env file requires explicit confirmation and admin approval."
  
  commit_violation_vi: "‚ùå Kh√¥ng ƒë∆∞·ª£c commit file .env. S·ª≠ d·ª•ng .env.example thay th·∫ø."
  commit_violation_en: "‚ùå Cannot commit .env file. Use .env.example instead."
  
  backup_created_vi: "‚úÖ ƒê√£ t·∫°o backup file .env t·∫°i: {backup_path}"
  backup_created_en: "‚úÖ Created .env backup at: {backup_path}"
  
  approval_required_vi: "üîí C·∫ßn approval t·ª´ admin ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y."
  approval_required_en: "üîí Admin approval required for this operation."

# Validation rules
validation:
  required_keys:             # C√°c keys b·∫Øt bu·ªôc trong .env
    - "OPENAI_API_KEY"
    - "OPENROUTER_API_KEY"
    - "DEEPSEEK_API_KEY"
    - "OLLAMA_API_URL"
    - "PREFERRED_MODEL_NAME"
    - "FALLBACK_MODEL_NAME"
  
  key_patterns:              # Pattern validation cho keys
    OPENAI_API_KEY: "^sk-proj-[a-zA-Z0-9_-]+$"
    OPENROUTER_API_KEY: "^sk-or-v1-[a-zA-Z0-9_-]+$"
    DEEPSEEK_API_KEY: "^sk-[a-zA-Z0-9_-]+$"
    OLLAMA_API_URL: "^https?://[a-zA-Z0-9.-]+:[0-9]+$"
  
  file_size_limit: 1048576   # 1MB limit cho .env file
  line_limit: 1000           # T·ªëi ƒëa 1000 d√≤ng
  
  encoding: "utf-8"          # Ch·ªâ cho ph√©p UTF-8 encoding
  line_endings: "unix"       # Ch·ªâ cho ph√©p Unix line endings

# Backup configuration
backup:
  enabled: true
  directory: ".env_backups"
  max_backups: 10            # Gi·ªØ t·ªëi ƒëa 10 backups
  compression: true          # N√©n backup files
  encryption: false          # Kh√¥ng m√£ ho√° (c√≥ th·ªÉ b·∫≠t sau)
  
  # Backup triggers
  triggers:
    - "before_delete"
    - "before_rename"
    - "before_move"
    - "before_modify"
    - "daily"                # Backup h√†ng ng√†y
    - "weekly"               # Backup h√†ng tu·∫ßn
  
  # Backup naming pattern
  naming_pattern: ".env.backup.{timestamp}.{operation}"
  timestamp_format: "%Y%m%d_%H%M%S"

# Monitoring configuration
monitoring:
  enabled: true
  log_file: "logs/file_protection.log"
  log_level: "INFO"
  
  # Events to monitor
  events:
    - "file_access"
    - "file_modify"
    - "file_delete"
    - "file_rename"
    - "file_move"
    - "backup_created"
    - "validation_failed"
    - "approval_required"
    - "policy_violation"
  
  # Alerts
  alerts:
    critical_violation:
      enabled: true
      channels: ["console", "log", "email"]
      threshold: 1            # Alert ngay l·∫≠p t·ª©c
    
    multiple_violations:
      enabled: true
      channels: ["console", "log"]
      threshold: 3            # Alert sau 3 violations
      time_window: 3600       # Trong 1 gi·ªù

# Integration v·ªõi tools
integrations:
  git:
    pre_commit_hook: true
    post_commit_hook: false
    pre_push_hook: true
    
  ci_cd:
    check_protected_files: true
    validate_env_files: true
    backup_on_deploy: true
    
  ide:
    cursor_rules: true
    vscode_settings: true
    intellij_settings: true
    
  file_system:
    inotify: true             # Linux
    fsevents: true            # macOS
    read_directory_changes: true  # Windows

# Compliance requirements
compliance:
  required_for:
    - "All entrypoints"
    - "All build tools"
    - "All deployment scripts"
    - "All CI/CD pipelines"
    - "All development tools"
  
  must_load_policy: true
  must_validate_files: true
  must_backup_before_operations: true
  
  # Compliance checks
  checks:
    - "check_protected_files_exist"
    - "check_protected_files_not_committed"
    - "check_backup_system_working"
    - "check_validation_system_working"
    - "check_monitoring_system_working"

# Emergency procedures
emergency:
  # Khi .env b·ªã xo√° nh·∫ßm
  recovery_procedures:
    - "Check backup directory"
    - "Restore from latest backup"
    - "Validate restored file"
    - "Notify admin"
    - "Update monitoring"
  
  # Khi .env b·ªã commit nh·∫ßm
  git_recovery:
    - "Remove from git history"
    - "Add to .gitignore"
    - "Force push (if safe)"
    - "Notify team"
    - "Rotate secrets"
  
  # Contact information
  emergency_contacts:
    admin: "admin@stillme-ai.com"
    security: "security@stillme-ai.com"
    devops: "devops@stillme-ai.com"

# Policy enforcement
enforcement:
  # Runtime enforcement
  runtime:
    enabled: true
    strict_mode: true         # Strict mode - block all violations
    grace_period: 0           # Kh√¥ng c√≥ grace period
    
  # Development enforcement
  development:
    enabled: true
    strict_mode: false        # Relaxed mode cho development
    grace_period: 300         # 5 ph√∫t grace period
    
  # Production enforcement
  production:
    enabled: true
    strict_mode: true         # Strict mode cho production
    grace_period: 0           # Kh√¥ng c√≥ grace period
    
  # Testing enforcement
  testing:
    enabled: true
    strict_mode: false        # Relaxed mode cho testing
    grace_period: 60          # 1 ph√∫t grace period
