name: Tests (Simple - Debug)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/tests-simple.yml'
      - 'tests/**'
      - 'requirements.txt'

jobs:
  test-simple:
    name: Simple Test Run
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov
          
      - name: Check Python and pytest
        run: |
          python --version
          pytest --version
          echo "PYTHONPATH: $PYTHONPATH"
          
      - name: List test files
        run: |
          echo "=== Test files ==="
          find tests -name "test_*.py" -type f | head -10
          echo "=== Total ==="
          find tests -name "test_*.py" -type f | wc -l
          
      - name: Run a single simple test (if exists)
        run: |
          if [ -f tests/test_rss_fetcher.py ]; then
            echo "Running test_rss_fetcher.py..."
            pytest tests/test_rss_fetcher.py -v --tb=short || echo "Test failed but continuing..."
          else
            echo "test_rss_fetcher.py not found"
          fi
        env:
          ENVIRONMENT: test
          PYTHONPATH: ${{ github.workspace }}
        continue-on-error: true
          
      - name: Try to run all tests (with max 3 failures)
        run: |
          pytest tests/ \
            -v \
            --tb=short \
            --maxfail=3 \
            -x || echo "Tests completed with some failures"
        env:
          ENVIRONMENT: test
          DEEPSEEK_API_KEY: test_key
          OPENAI_API_KEY: test_key
          PYTHONPATH: ${{ github.workspace }}
        continue-on-error: true

