name: Security CI Pipeline

on:
  push:
    branches:
      - main
      - develop
      - feature/*
    paths:
      - '**.py'
      - '**.yaml'
      - '**.yml'
      - '**.json'
      - 'requirements*.txt'
      - '.github/workflows/security-ci.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.py'
      - '**.yaml'
      - '**.yml'
      - '**.json'
      - 'requirements*.txt'
      - '.github/workflows/security-ci.yml'
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety semgrep pip-audit detect-secrets
    
    - name: Create artifacts directory
      run: mkdir -p artifacts
    
    - name: Run Bandit (Static Analysis)
      run: |
        bandit -r stillme_core/ -f json -o artifacts/bandit-report.json || true
        bandit -r stillme_core/ -f txt -o artifacts/bandit-report.txt || true
      continue-on-error: true
    
    - name: Run Semgrep (Code Security)
      run: |
        semgrep --config=auto stillme_core/ --json --output=artifacts/semgrep-report.json || true
        semgrep --config=auto stillme_core/ --text --output=artifacts/semgrep-report.txt || true
      continue-on-error: true
    
    - name: Run pip-audit (Dependency Vulnerabilities)
      run: |
        pip-audit -r requirements.txt --format json --output artifacts/pip-audit-report.json || true
        pip-audit -r requirements.txt --format text --output artifacts/pip-audit-report.txt || true
      continue-on-error: true
    
    - name: Run detect-secrets (Secret Detection)
      run: |
        detect-secrets scan --all-files --baseline artifacts/secrets-baseline.json || true
        detect-secrets audit artifacts/secrets-baseline.json || true
      continue-on-error: true
    
    - name: Run Safety (Dependency Check)
      run: |
        safety check -r requirements.txt --json --output artifacts/safety-report.json || true
        safety check -r requirements.txt --full-report --output artifacts/safety-report.txt || true
      continue-on-error: true
    
    - name: Generate Security Summary
      run: |
        echo "# Security Scan Summary" > artifacts/security-summary.md
        echo "Generated: $(date)" >> artifacts/security-summary.md
        echo "" >> artifacts/security-summary.md
        
        # Bandit summary
        if [ -f artifacts/bandit-report.json ]; then
          echo "## Bandit Results" >> artifacts/security-summary.md
          echo "- Report: bandit-report.json" >> artifacts/security-summary.md
          echo "" >> artifacts/security-summary.md
        fi
        
        # Semgrep summary
        if [ -f artifacts/semgrep-report.json ]; then
          echo "## Semgrep Results" >> artifacts/security-summary.md
          echo "- Report: semgrep-report.json" >> artifacts/security-summary.md
          echo "" >> artifacts/security-summary.md
        fi
        
        # pip-audit summary
        if [ -f artifacts/pip-audit-report.json ]; then
          echo "## Dependency Vulnerabilities" >> artifacts/security-summary.md
          echo "- Report: pip-audit-report.json" >> artifacts/security-summary.md
          echo "" >> artifacts/security-summary.md
        fi
        
        # Safety summary
        if [ -f artifacts/safety-report.json ]; then
          echo "## Safety Check Results" >> artifacts/security-summary.md
          echo "- Report: safety-report.json" >> artifacts/security-summary.md
          echo "" >> artifacts/security-summary.md
        fi
        
        # Secrets summary
        if [ -f artifacts/secrets-baseline.json ]; then
          echo "## Secret Detection Results" >> artifacts/security-summary.md
          echo "- Report: secrets-baseline.json" >> artifacts/security-summary.md
          echo "" >> artifacts/security-summary.md
        fi
    
    - name: Upload Security Reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports-${{ github.run_number }}
        path: artifacts/
        retention-days: 30
    
    - name: Security Gate Check
      run: |
        # Check for critical vulnerabilities
        if [ -f artifacts/bandit-report.json ]; then
          HIGH_ISSUES=$(jq '.results[] | select(.issue_severity == "HIGH") | .test_id' artifacts/bandit-report.json | wc -l)
          if [ "$HIGH_ISSUES" -gt 0 ]; then
            echo "‚ùå Found $HIGH_ISSUES high severity security issues"
            exit 1
          fi
        fi
        
        # Check for dependency vulnerabilities
        if [ -f artifacts/pip-audit-report.json ]; then
          VULNERABILITIES=$(jq '.vulnerabilities | length' artifacts/pip-audit-report.json)
          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "‚ùå Found $VULNERABILITIES dependency vulnerabilities"
            exit 1
          fi
        fi
        
        echo "‚úÖ Security scan passed - no critical issues found"

  ethics-scan:
    runs-on: ubuntu-latest
    name: Ethics Scan
    needs: security-scan
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run Ethics Tests
      run: |
        if [ -d "ethics-tests" ]; then
          cd ethics-tests
          python runners/ethics_test_runner.py --ci-mode --max-violations 0.1
        else
          echo "‚ö†Ô∏è Ethics tests not found - skipping"
        fi
      continue-on-error: true
    
    - name: Ethics Gate Check
      run: |
        if [ -f "ethics-tests/results/violation_rate.txt" ]; then
          VIOLATION_RATE=$(cat ethics-tests/results/violation_rate.txt)
          if (( $(echo "$VIOLATION_RATE > 0.1" | bc -l) )); then
            echo "‚ùå Ethics violation rate too high: $VIOLATION_RATE%"
            exit 1
          fi
          echo "‚úÖ Ethics scan passed - violation rate: $VIOLATION_RATE%"
        else
          echo "‚ö†Ô∏è Ethics test results not found"
        fi

  compliance-check:
    runs-on: ubuntu-latest
    name: Compliance Check
    needs: [security-scan, ethics-scan]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check Security Policy
      run: |
        if [ -f "policies/SECURITY_POLICY.yaml" ]; then
          echo "‚úÖ Security policy found"
        else
          echo "‚ùå Security policy missing"
          exit 1
        fi
    
    - name: Check Privacy Policy
      run: |
        if [ -f "docs/PRIVACY_MODE.md" ]; then
          echo "‚úÖ Privacy documentation found"
        else
          echo "‚ùå Privacy documentation missing"
          exit 1
        fi
    
    - name: Check Ethics Guidelines
      run: |
        if [ -f "config/ethical_rules.json" ]; then
          echo "‚úÖ Ethics rules found"
        else
          echo "‚ùå Ethics rules missing"
          exit 1
        fi
    
    - name: Check Documentation
      run: |
        REQUIRED_DOCS=("README.md" "docs/SECURITY.md" "docs/ETHICS.md" "docs/PRIVACY.md")
        for doc in "${REQUIRED_DOCS[@]}"; do
          if [ -f "$doc" ]; then
            echo "‚úÖ $doc found"
          else
            echo "‚ùå $doc missing"
            exit 1
          fi
        done
    
    - name: Compliance Summary
      run: |
        echo "‚úÖ All compliance checks passed"
        echo "üìã Security Policy: ‚úÖ"
        echo "üîí Privacy Controls: ‚úÖ"
        echo "üõ°Ô∏è Ethics Guidelines: ‚úÖ"
        echo "üìö Documentation: ‚úÖ"
