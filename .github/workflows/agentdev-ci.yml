name: AgentDev CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '18'

jobs:
  # Job 1: Code Quality & Security
  quality-gate:
    name: ðŸ›¡ï¸ Code Quality & Security Gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
        pip install safety bandit semgrep
    
    - name: ðŸ” Run Code Quality Analysis
      run: |
        echo "ðŸ” Running comprehensive code quality analysis..."
        
        # Run ruff for fast linting
        echo "ðŸ“‹ Running ruff..."
        ruff check . --output-format=github
        
        # Run pylint for detailed analysis
        echo "ðŸ”¬ Running pylint..."
        pylint stillme_core/ --output-format=json --reports=y > pylint-report.json || true
        
        # Run mypy for type checking
        echo "ðŸ”Ž Running mypy..."
        mypy stillme_core/ --junit-xml mypy-report.xml || true
        
        # Run black for formatting check
        echo "ðŸŽ¨ Checking code formatting..."
        black --check --diff .
        
        # Run isort for import sorting
        echo "ðŸ“š Checking import sorting..."
        isort --check-only --diff .
    
    - name: ðŸ›¡ï¸ Security Scanning
      run: |
        echo "ðŸ›¡ï¸ Running security scans..."
        
        # Safety check for known vulnerabilities
        echo "ðŸ”’ Checking for known vulnerabilities..."
        safety check --json --output safety-report.json || true
        
        # Bandit for security issues
        echo "ðŸš¨ Running bandit security scan..."
        bandit -r stillme_core/ -f json -o bandit-report.json || true
        
        # Semgrep for advanced security patterns
        echo "ðŸ” Running semgrep security scan..."
        semgrep --config=auto --json --output=semgrep-report.json . || true
    
    - name: ðŸ“Š Upload Quality Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-reports
        path: |
          pylint-report.json
          mypy-report.xml
          safety-report.json
          bandit-report.json
          semgrep-report.json
        retention-days: 30

  # Job 2: Testing
  test:
    name: ðŸ§ª Testing Suite
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: quality-gate
    
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
        pip install pytest-cov pytest-xdist
    
    - name: ðŸ§ª Run Unit Tests
      run: |
        echo "ðŸ§ª Running unit tests..."
        pytest tests/ -v --cov=stillme_core --cov-report=xml --cov-report=html --junitxml=pytest-report.xml
    
    - name: ðŸ§ª Run AgentDev Self-Tests
      run: |
        echo "ðŸ¤– Running AgentDev self-tests..."
        python stillme_cli_final.py doctor
        python stillme_cli_final.py status
        python stillme_cli_final.py quality-check stillme_core/quality --tool ruff
    
    - name: ðŸ“Š Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-${{ matrix.os }}-${{ matrix.python-version }}
        path: |
          pytest-report.xml
          coverage.xml
          htmlcov/
        retention-days: 30

  # Job 3: Integration Testing
  integration-test:
    name: ðŸ”— Integration Testing
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: test
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
        pip install redis pytest-redis
    
    - name: ðŸ”— Run Integration Tests
      run: |
        echo "ðŸ”— Running integration tests..."
        pytest tests/integration/ -v --junitxml=integration-report.xml || echo "No integration tests found"
    
    - name: ðŸ¤– Test AgentDev CLI Integration
      run: |
        echo "ðŸ¤– Testing AgentDev CLI integration..."
        
        # Test CLI commands
        python stillme_cli_final.py info
        python stillme_cli_final.py doctor
        python stillme_cli_final.py status
        
        # Test quality analysis on different paths
        python stillme_cli_final.py quality-check . --tool ruff
        python stillme_cli_final.py quality-check stillme_core/ --tool pylint
    
    - name: ðŸ“Š Upload Integration Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-reports
        path: integration-report.xml
        retention-days: 30

  # Job 4: Build & Package
  build:
    name: ðŸ“¦ Build & Package
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [quality-gate, test, integration-test]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: ðŸ—ï¸ Build package
      run: |
        echo "ðŸ—ï¸ Building StillMe package..."
        python -m build
    
    - name: ðŸ“Š Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: dist/
        retention-days: 30

  # Job 5: Deployment (Conditional)
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [quality-gate, test, integration-test, build]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist-packages
        path: dist/
    
    - name: ðŸš€ Deploy to Staging
      if: github.event.inputs.environment == 'staging' || (github.ref == 'refs/heads/main' && github.event.inputs.environment != 'production')
      run: |
        echo "ðŸš€ Deploying to staging environment..."
        # Add your staging deployment logic here
        echo "âœ… Staging deployment completed"
    
    - name: ðŸš€ Deploy to Production
      if: github.event.inputs.environment == 'production'
      run: |
        echo "ðŸš€ Deploying to production environment..."
        # Add your production deployment logic here
        echo "âœ… Production deployment completed"

  # Job 6: AgentDev Self-Improvement
  agentdev-self-improvement:
    name: ðŸ¤– AgentDev Self-Improvement
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [quality-gate, test, integration-test]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
    
    - name: ðŸ¤– Run AgentDev Self-Analysis
      run: |
        echo "ðŸ¤– Running AgentDev self-analysis..."
        
        # Analyze code quality trends
        python stillme_cli_final.py quality-check . --output quality-trends.json
        
        # Generate improvement suggestions
        python -c "
        import json
        import subprocess
        
        # Run quality analysis
        result = subprocess.run(['python', 'stillme_cli_final.py', 'quality-check', '.', '--tool', 'ruff'], 
                              capture_output=True, text=True)
        
        # Generate improvement suggestions
        suggestions = {
            'timestamp': subprocess.run(['date', '-Iseconds'], capture_output=True, text=True).stdout.strip(),
            'quality_score': 'Generated from analysis',
            'suggestions': [
                'Consider adding more unit tests for edge cases',
                'Review and optimize import statements',
                'Add type hints to improve code clarity',
                'Consider breaking down large functions'
            ]
        }
        
        with open('improvement-suggestions.json', 'w') as f:
            json.dump(suggestions, f, indent=2)
        "
    
    - name: ðŸ“Š Create Improvement Report
      run: |
        echo "ðŸ“Š Creating improvement report..."
        
        # Create a markdown report
        cat > improvement-report.md << EOF
        # AgentDev Self-Improvement Report
        
        **Date:** $(date)
        **Branch:** ${{ github.ref_name }}
        **Commit:** ${{ github.sha }}
        
        ## Quality Analysis Results
        
        \`\`\`
        $(python stillme_cli_final.py quality-check . --tool ruff)
        \`\`\`
        
        ## System Status
        
        \`\`\`
        $(python stillme_cli_final.py status)
        \`\`\`
        
        ## Recommendations
        
        1. **Code Quality**: Continue monitoring quality metrics
        2. **Testing**: Increase test coverage for critical paths
        3. **Documentation**: Keep documentation up to date
        4. **Performance**: Monitor and optimize performance bottlenecks
        
        ## Next Steps
        
        - [ ] Review quality trends
        - [ ] Implement suggested improvements
        - [ ] Update documentation
        - [ ] Plan next iteration
        EOF
    
    - name: ðŸ’¾ Commit Improvement Report
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add improvement-report.md
        git commit -m "ðŸ¤– AgentDev self-improvement report - $(date)" || exit 0
        git push || exit 0

  # Job 7: Notification
  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [quality-gate, test, integration-test, build, deploy]
    if: always()
    
    steps:
    - name: ðŸ“¢ Notify Success
      if: needs.deploy.result == 'success'
      run: |
        echo "âœ… All CI/CD jobs completed successfully!"
        echo "ðŸš€ Deployment completed to ${{ github.event.inputs.environment || 'staging' }}"
    
    - name: ðŸ“¢ Notify Failure
      if: needs.deploy.result == 'failure'
      run: |
        echo "âŒ CI/CD pipeline failed!"
        echo "Please check the logs for details."
        exit 1
