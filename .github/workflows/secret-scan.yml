name: Secret Scan (Light)
on: 
  pull_request:
    branches: [ main, develop, feature/* ]
  push:
    branches: [ main, develop ]

permissions: 
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Install ripgrep
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep
          
      - name: Heuristic secret scan
        run: |
          set -e
          echo "üîç Scanning for potential secrets..."
          
          # Scan for API keys, tokens, and secrets
          if rg -n "(sk-[A-Za-z0-9]{20,}|API_KEY=|SECRET=|TOKEN=|PASSWORD=)" \
            -g '!_attic/**' \
            -g '!*sample*' \
            -g '!*example*' \
            -g '!*test*' \
            -g '!*.md' \
            -g '!*.yml' \
            -g '!*.yaml' \
            -g '!*.json' \
            -g '!*.txt' \
            -g '!*.log' \
            . | grep -v 'REPLACE_ME' | grep -v 'your_.*_here' | grep -v 'sk-xxxx' | grep -v 'test_key_for_testing_purposes_only'; then
            echo "‚ùå POTENTIAL SECRETS DETECTED!"
            echo ""
            echo "Found potential secrets in the following files:"
            rg -n "(sk-[A-Za-z0-9]{20,}|API_KEY=|SECRET=|TOKEN=|PASSWORD=)" \
              -g '!_attic/**' \
              -g '!*sample*' \
              -g '!*example*' \
              -g '!*test*' \
              -g '!*.md' \
              -g '!*.yml' \
              -g '!*.yaml' \
              -g '!*.json' \
              -g '!*.txt' \
              -g '!*.log' \
              . | grep -v 'REPLACE_ME' | grep -v 'your_.*_here' | grep -v 'sk-xxxx' | grep -v 'test_key_for_testing_purposes_only'
            echo ""
            echo "üí° To fix:"
            echo "  1. Remove or redact secrets from your code"
            echo "  2. Use placeholder values like 'REPLACE_ME' or 'your_key_here'"
            echo "  3. Use environment variables or GitHub Secrets for real values"
            echo "  4. Never commit real API keys or passwords"
            echo ""
            exit 1
          fi
          
          # Check for .env files (should be ignored by gitignore)
          if find . -name ".env*" -not -name ".env.example" | grep -v ".git"; then
            echo "‚ùå .env FILES DETECTED!"
            echo ""
            echo "Found .env files that should not be committed:"
            find . -name ".env*" -not -name ".env.example" | grep -v ".git"
            echo ""
            echo "üí° To fix:"
            echo "  1. Add .env files to .gitignore"
            echo "  2. Use .env.example as template"
            echo "  3. Create .env.local for local development"
            echo ""
            exit 1
          fi
          
          echo "‚úÖ No secrets detected!"
          
      - name: Check environment configuration
        run: |
          echo "üîç Checking environment configuration..."
          
          # Check if .env.example exists and has proper structure
          if [ ! -f ".env.example" ]; then
            echo "‚ùå .env.example file not found!"
            echo "üí° Create .env.example with placeholder values"
            exit 1
          fi
          
          # Check if .env.example contains placeholder values
          if grep -q "REPLACE_ME\|your_.*_here\|sk-xxxx" .env.example; then
            echo "‚úÖ .env.example contains proper placeholder values"
          else
            echo "‚ö†Ô∏è  .env.example may contain real secrets!"
            echo "üí° Ensure .env.example only contains placeholder values"
          fi
          
          echo "‚úÖ Environment configuration check passed!"
