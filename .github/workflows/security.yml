name: Security Scan

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: 3.12
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety semgrep gitleaks
    
    - name: Run Bandit security linter
      run: |
        bandit -r stillme_core/ -f json -o bandit-report.json || true
        bandit -r stillme_core/ -f txt
    
    - name: Run Safety check for known vulnerabilities
      run: |
        safety check --json --output safety-report.json || true
        safety check
    
    - name: Run Semgrep security analysis
      run: |
        semgrep --config=auto --json --output=semgrep-report.json stillme_core/ || true
        semgrep --config=auto stillme_core/
    
    - name: Run Gitleaks for secret detection
      run: |
        gitleaks detect --source . --report-format json --report-path gitleaks-report.json || true
        gitleaks detect --source .
    
    - name: Check for hardcoded secrets in Reflex Engine
      run: |
        echo "Checking for hardcoded secrets in Reflex Engine..."
        if grep -r "sk-" stillme_core/middleware/ || grep -r "api_key" stillme_core/middleware/ || grep -r "password" stillme_core/middleware/; then
          echo "❌ Potential hardcoded secrets found!"
          exit 1
        else
          echo "✅ No hardcoded secrets found"
        fi
    
    - name: Validate privacy compliance
      run: |
        echo "Validating privacy compliance..."
        python -c "
        import yaml
        with open('config/reflex_engine.yaml', 'r') as f:
            config = yaml.safe_load(f)
        
        # Check privacy settings
        privacy = config.get('privacy', {})
        if not privacy.get('enabled', False):
            print('❌ Privacy not enabled')
            exit(1)
        
        if privacy.get('habits_opt_in', True):  # Default should be opt-out
            print('❌ Habits should be opt-out by default')
            exit(1)
        
        if not privacy.get('hash_cues', False):
            print('❌ Cue hashing should be enabled')
            exit(1)
        
        print('✅ Privacy compliance validated')
        "
    
    - name: Check for PII in logs
      run: |
        echo "Checking for PII in log statements..."
        if grep -r "email\|phone\|ssn\|credit" stillme_core/middleware/ --include="*.py"; then
          echo "❌ Potential PII found in code!"
          exit 1
        else
          echo "✅ No PII found in code"
        fi
    
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          semgrep-report.json
          gitleaks-report.json

  dependency-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: 3.12
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pip-audit
    
    - name: Run pip-audit
      run: |
        pip-audit --format=json --output=pip-audit-report.json || true
        pip-audit
    
    - name: Upload dependency scan results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-scan-results
        path: pip-audit-report.json

  reflex-engine-security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: 3.12
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest
    
    - name: Run Reflex Engine security tests
      run: |
        pytest tests/test_reflex_safety.py -v
    
    - name: Test shadow mode enforcement
      run: |
        python -c "
        from stillme_core.middleware.reflex_engine import ReflexEngine
        engine = ReflexEngine()
        result = engine.analyze(text='test', user_id='test_user')
        assert result['shadow'] == True, 'Shadow mode must be enforced'
        assert result['decision'] == 'fallback', 'Must fallback in shadow mode'
        print('✅ Shadow mode properly enforced')
        "
    
    - name: Test habit store privacy
      run: |
        python -c "
        from stillme_core.middleware.habit_store import HabitStore
        store = HabitStore()
        assert not store.is_enabled(), 'Habit store should be disabled by default'
        print('✅ Habit store privacy properly configured')
        "
    
    - name: Test observability privacy
      run: |
        python -c "
        from stillme_core.middleware.observability import ObservabilityManager
        obs = ObservabilityManager()
        # Test that no PII is logged
        obs.log_reflex_decision('test-trace', 'fallback', 0.5, 1.0, {}, {}, 'user123', 'tenant456')
        print('✅ Observability privacy validated')
        "