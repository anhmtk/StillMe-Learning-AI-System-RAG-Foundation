name: SEAL-GRADE Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

env:
  PYTHON_VERSION: '3.11'

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety semgrep detect-secrets
        pip install -r requirements.txt
        
    - name: Run Bandit security scan
      run: |
        bandit -r stillme_core/ modules/ \
          -f json -o reports/bandit_report.json \
          -ll || true
        bandit -r stillme_core/ modules/ \
          -f txt -o reports/bandit_report.txt \
          -ll || true
          
    - name: Run Safety dependency check
      run: |
        safety check --json --output reports/safety_report.json || true
        safety check --output reports/safety_report.txt || true
        
    - name: Run Semgrep static analysis
      run: |
        semgrep --config=auto \
          --json --output=reports/semgrep_report.json \
          stillme_core/ modules/ || true
        semgrep --config=auto \
          --output=reports/semgrep_report.txt \
          stillme_core/ modules/ || true
          
    - name: Run Detect Secrets scan
      run: |
        detect-secrets scan --all-files \
          --baseline .secrets.baseline || true
        detect-secrets audit .secrets.baseline || true
        
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v2
      with:
        languages: python
        
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      
    - name: Upload security scan artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-scan-reports
        path: |
          reports/bandit_report.json
          reports/bandit_report.txt
          reports/safety_report.json
          reports/safety_report.txt
          reports/semgrep_report.json
          reports/semgrep_report.txt
          .secrets.baseline

  dependency-scan:
    name: Dependency Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pip-audit
        
    - name: Run pip-audit
      run: |
        pip-audit --format=json --output=reports/pip_audit_report.json || true
        pip-audit --format=text --output=reports/pip_audit_report.txt || true
        
    - name: Upload dependency scan artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dependency-scan-reports
        path: |
          reports/pip_audit_report.json
          reports/pip_audit_report.txt

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-html
        
    - name: Run security tests
      run: |
        pytest tests/test_security_ethics.py \
          -v \
          --html=reports/security_test_report.html \
          --self-contained-html \
          -m "security or ethics" \
          --junitxml=reports/security_test_results.xml
          
    - name: Upload security test artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-test-reports
        path: |
          reports/security_test_report.html
          reports/security_test_results.xml

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-scan, security-tests]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      
    - name: Generate security summary
      run: |
        mkdir -p reports
        cat > reports/security_summary.md << EOF
        # SEAL-GRADE Security Summary
        
        ## Security Scan Results
        
        ### Static Analysis
        - **Bandit**: ${{ needs.security-scan.result }}
        - **Semgrep**: ${{ needs.security-scan.result }}
        - **CodeQL**: ${{ needs.security-scan.result }}
        
        ### Dependency Scan
        - **Safety**: ${{ needs.dependency-scan.result }}
        - **pip-audit**: ${{ needs.dependency-scan.result }}
        
        ### Security Tests
        - **Injection Tests**: ${{ needs.security-tests.result }}
        - **Jailbreak Tests**: ${{ needs.security-tests.result }}
        - **PII Redaction Tests**: ${{ needs.security-tests.result }}
        
        ## Overall Security Status
        - **Static Analysis**: ${{ needs.security-scan.result }}
        - **Dependency Scan**: ${{ needs.dependency-scan.result }}
        - **Security Tests**: ${{ needs.security-tests.result }}
        
        ## Artifacts
        - Security scan reports: security-scan-reports
        - Dependency scan reports: dependency-scan-reports
        - Security test reports: security-test-reports
        
        Generated on: $(date)
        EOF
        
    - name: Upload security summary
      uses: actions/upload-artifact@v3
      with:
        name: security-summary
        path: reports/security_summary.md
        
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('reports/security_summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });