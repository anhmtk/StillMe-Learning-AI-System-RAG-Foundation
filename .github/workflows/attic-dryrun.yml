name: ðŸ—‚ï¸ Attic Dry-Run (Weekly)

on:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  attic-dryrun:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install grimp networkx scikit-learn pytest pytest-cov coverage pyyaml
    
    - name: Run attic sweeper (dry-run)
      run: |
        echo "ðŸ—‚ï¸ Running attic sweeper in dry-run mode..."
        python tools/inventory/attic_sweeper.py --days 30 --dry-run --output artifacts/attic_eviction_candidates.csv
    
    - name: Check eviction candidates
      run: |
        echo "ðŸ“Š Checking eviction candidates..."
        if [ -f "artifacts/attic_eviction_candidates.csv" ]; then
          CANDIDATE_COUNT=$(tail -n +2 artifacts/attic_eviction_candidates.csv | wc -l)
          EVICTION_COUNT=$(tail -n +2 artifacts/attic_eviction_candidates.csv | grep -c "true" || echo "0")
          echo "ðŸ“ˆ Total files in attic: $CANDIDATE_COUNT"
          echo "ðŸ—‘ï¸  Eviction candidates: $EVICTION_COUNT"
          
          if [ "$EVICTION_COUNT" -gt 0 ]; then
            echo "âš ï¸  Found $EVICTION_COUNT files ready for eviction!"
            echo "ðŸ“‹ Top candidates:"
            tail -n +2 artifacts/attic_eviction_candidates.csv | grep "true" | head -5 | while IFS=',' read -r path original days refs protected reason candidate timestamp; do
              echo "  - $path ($days days in attic)"
            done
          else
            echo "âœ… No files ready for eviction"
          fi
        else
          echo "âŒ No eviction candidates file found"
        fi
    
    - name: Upload attic artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: attic-dryrun-artifacts-${{ github.run_number }}
        path: |
          artifacts/attic_eviction_candidates.csv
          artifacts/attic_moves.csv
        retention-days: 90
    
    - name: Generate summary
      run: |
        echo "## ðŸ—‚ï¸ Weekly Attic Dry-Run Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "artifacts/attic_eviction_candidates.csv" ]; then
          CANDIDATE_COUNT=$(tail -n +2 artifacts/attic_eviction_candidates.csv | wc -l)
          EVICTION_COUNT=$(tail -n +2 artifacts/attic_eviction_candidates.csv | grep -c "true" || echo "0")
          echo "- **Total files in attic:** $CANDIDATE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Eviction candidates:** $EVICTION_COUNT" >> $GITHUB_STEP_SUMMARY
          
          if [ "$EVICTION_COUNT" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ—‘ï¸ Ready for Eviction" >> $GITHUB_STEP_SUMMARY
            echo "| File | Days in Attic | Reason |" >> $GITHUB_STEP_SUMMARY
            echo "|------|---------------|--------|" >> $GITHUB_STEP_SUMMARY
            tail -n +2 artifacts/attic_eviction_candidates.csv | grep "true" | head -10 | while IFS=',' read -r path original days refs protected reason candidate timestamp; do
              echo "| \`$path\` | $days | $reason |" >> $GITHUB_STEP_SUMMARY
            done
          fi
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Review eviction candidates in artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Plan controlled deletion in Wave-2b if no issues found" >> $GITHUB_STEP_SUMMARY
        echo "- Monitor for 1-2 weeks before permanent deletion" >> $GITHUB_STEP_SUMMARY
