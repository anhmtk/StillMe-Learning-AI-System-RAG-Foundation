name: SEAL-GRADE CI Tests

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-html pytest-xdist
        pip install bandit safety semgrep
        
    - name: Run unit tests
      run: |
        pytest tests/test_unit_core_modules.py \
          -v \
          --cov=stillme_core \
          --cov=modules \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --cov-fail-under=90 \
          --html=reports/unit_test_report.html \
          --self-contained-html \
          -m "unit" \
          --junitxml=reports/unit_test_results.xml
          
    - name: Upload unit test coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unit
        name: unit-tests
        
    - name: Upload unit test artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: unit-test-reports
        path: |
          reports/unit_test_report.html
          reports/unit_test_results.xml
          htmlcov/

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-html pytest-xdist
        
    - name: Run integration tests
      run: |
        pytest tests/test_integration_cross_module.py \
          -v \
          --html=reports/integration_test_report.html \
          --self-contained-html \
          -m "integration" \
          --junitxml=reports/integration_test_results.xml
          
    - name: Upload integration test artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-reports
        path: |
          reports/integration_test_report.html
          reports/integration_test_results.xml

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-html bandit safety semgrep
        
    - name: Run security tests
      run: |
        pytest tests/test_security_ethics.py \
          -v \
          --html=reports/security_test_report.html \
          --self-contained-html \
          -m "security or ethics" \
          --junitxml=reports/security_test_results.xml
          
    - name: Run Bandit security scan
      run: |
        bandit -r stillme_core/ modules/ -f json -o reports/bandit_report.json || true
        bandit -r stillme_core/ modules/ -f txt -o reports/bandit_report.txt || true
        
    - name: Run Safety check
      run: |
        safety check --json --output reports/safety_report.json || true
        safety check --output reports/safety_report.txt || true
        
    - name: Run Semgrep scan
      run: |
        semgrep --config=auto --json --output=reports/semgrep_report.json stillme_core/ modules/ || true
        semgrep --config=auto --output=reports/semgrep_report.txt stillme_core/ modules/ || true
        
    - name: Upload security test artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-test-reports
        path: |
          reports/security_test_report.html
          reports/security_test_results.xml
          reports/bandit_report.json
          reports/bandit_report.txt
          reports/safety_report.json
          reports/safety_report.txt
          reports/semgrep_report.json
          reports/semgrep_report.txt

  chaos-tests:
    name: Chaos Engineering Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-html
        
    - name: Run chaos tests
      run: |
        pytest tests/test_integration_cross_module.py \
          -v \
          --html=reports/chaos_test_report.html \
          --self-contained-html \
          -m "chaos" \
          --junitxml=reports/chaos_test_results.xml
          
    - name: Upload chaos test artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: chaos-test-reports
        path: |
          reports/chaos_test_report.html
          reports/chaos_test_results.xml

  load-tests:
    name: Load Tests
    runs-on: ubuntu-latest
    needs: [integration-tests, security-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Install K6
      run: |
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
        
    - name: Start test server
      run: |
        # Start the server in background
        python stable_ai_server.py &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        # Wait for server to start
        sleep 10
        
        # Check if server is running
        curl -f http://localhost:1216/health/ai || exit 1
        
    - name: Run load tests
      run: |
        cd k6
        chmod +x run_load_tests.sh
        ./run_load_tests.sh --load --duration 1m --users 50
        
    - name: Stop test server
      if: always()
      run: |
        kill $SERVER_PID || true
        
    - name: Upload load test artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: load-test-reports
        path: |
          k6/reports/

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-tests, chaos-tests]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      
    - name: Generate test summary
      run: |
        mkdir -p reports
        cat > reports/test_summary.md << EOF
        # SEAL-GRADE Test Summary
        
        ## Test Results
        
        ### Unit Tests
        - Status: ${{ needs.unit-tests.result }}
        - Coverage: â‰¥90% lines, â‰¥80% branches
        
        ### Integration Tests
        - Status: ${{ needs.integration-tests.result }}
        - Cross-module communication tested
        
        ### Security Tests
        - Status: ${{ needs.security-tests.result }}
        - Injection, jailbreak, PII redaction tested
        
        ### Chaos Engineering Tests
        - Status: ${{ needs.chaos-tests.result }}
        - Fault tolerance and recovery tested
        
        ### Load Tests
        - Status: ${{ needs.load-tests.result }}
        - Performance and scalability tested
        
        ## Overall Status
        - **Unit Tests**: ${{ needs.unit-tests.result }}
        - **Integration Tests**: ${{ needs.integration-tests.result }}
        - **Security Tests**: ${{ needs.security-tests.result }}
        - **Chaos Tests**: ${{ needs.chaos-tests.result }}
        - **Load Tests**: ${{ needs.load-tests.result }}
        
        ## Artifacts
        - Unit test reports: unit-test-reports
        - Integration test reports: integration-test-reports
        - Security test reports: security-test-reports
        - Chaos test reports: chaos-test-reports
        - Load test reports: load-test-reports
        
        Generated on: $(date)
        EOF
        
    - name: Upload test summary
      uses: actions/upload-artifact@v3
      with:
        name: test-summary
        path: reports/test_summary.md
        
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('reports/test_summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });