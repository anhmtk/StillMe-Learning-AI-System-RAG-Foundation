name: CI - Tests
on:
  push: { branches: [ main ] }
  pull_request: {}
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - run: pip install -r requirements.txt
      - run: pip install pytest pytest-cov junitparser
      - run: pytest -q --cov=. --cov-report=html --junitxml=reports/junit.xml
      - run: python scripts/extract_metrics.py
      - run: python scripts/update_readme_from_metrics.py docs/metrics.json README.md
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: htmlcov
      - name: Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: test-metrics
          path: docs/metrics.json
      - name: Create metrics PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "docs(readme): update test metrics diagram/table"
          branch: auto/update-metrics
          title: "Update README metrics (auto)"
          body: "Automated update of pass/fail metrics and diagram."
          delete-branch: true